<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The full process • envClean</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The full process">
<meta property="og:description" content="envClean">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">envClean</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/010_overview.html">Overview</a>
    </li>
    <li>
      <a href="../articles/020_clean.html">The full process</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Acanthiza/envClean/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="020_clean_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>The full process</h1>
                        <h4 class="author">Department for Environment and Water</h4>
                        <h4 class="author">Nigel Willoughby</h4>
            
            <h4 class="date">Thursday, 23 February, 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Acanthiza/envClean/blob/master/vignettes/020_clean.Rmd"><code>vignettes/020_clean.Rmd</code></a></small>
      <div class="hidden name"><code>020_clean.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">pacs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"knitr"</span>
            , <span class="st">"envClean"</span>
            , <span class="st">"envReport"</span>
            , <span class="st">"envFunc"</span>, <span class="st">"fs"</span>, <span class="st">"purrr"</span>
            , <span class="st">"dplyr"</span>, <span class="st">"sf"</span>, <span class="st">"tibble"</span>
            , <span class="st">"tmap"</span>, <span class="st">"raster"</span>, <span class="st">"rstanarm"</span>
            <span class="op">)</span>

  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">pacs</span>
              , <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">.</span>
                                                        , character.only <span class="op">=</span> <span class="cn">TRUE</span>
                                                        , quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                                                <span class="op">)</span>
              <span class="op">)</span>

  <span class="co">#  Load data</span>
  <span class="va">flor_all</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="fu">envClean</span><span class="fu">::</span><span class="va"><a href="../reference/flor_all.html">flor_all</a></span><span class="op">)</span>
  
  <span class="co"># What crs to use for maps?</span>
  <span class="va">use_crs</span> <span class="op">&lt;-</span> <span class="fl">3577</span> <span class="co"># actually an epsg code. see epsg.io</span>
  
  <span class="co"># set area of interest coordinate reference system</span>
  <span class="va">aoi</span> <span class="op">&lt;-</span> <span class="fu">envClean</span><span class="fu">::</span><span class="va"><a href="../reference/aoi.html">aoi</a></span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">use_crs</span><span class="op">)</span>
  </code></pre></div>
<div id="data" class="section level1">
<h1 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h1>
<p>Here, we’ll start with combined floristic data (called <code>flor_all</code>) from the mallee in South Australia. This data set is provided with <code>envClean</code> and is a small subset of a <a href="https://www.gbif.org/">GBIF</a> occurrence download <span class="citation">(GBIF.Org 2022)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">flor_all</span> <span class="op">&lt;-</span> <span class="va">flor_all</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="area-of-interest" class="section level1">
<h1 class="hasAnchor">
<a href="#area-of-interest" class="anchor"></a>Area of interest</h1>
<p>Usually this is a geographic and/or taxonomic area of interest. An example area overlapping <code>flor_all</code> is provided in <code>aoi</code>. Converting <code>flor_all</code> to <code>sf</code> allows plotting them together.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="co"># Create simple feature from flor_all</span>
  <span class="va">flor_all_sf</span> <span class="op">&lt;-</span> <span class="va">flor_all</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>, <span class="st">"lat"</span><span class="op">)</span>
                 , crs <span class="op">=</span> <span class="fl">4326</span>
                 <span class="op">)</span>

  <span class="co"># Plot flor_all along with aoi</span>
  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">aoi</span>
           , bbox <span class="op">=</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">flor_all_sf</span><span class="op">)</span>
           <span class="op">)</span> <span class="op">+</span>
    <span class="fu">tm_polygons</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">flor_all_sf</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">tm_dots</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="020_clean_files/figure-html/aoi-1.png" width="700"></p>
<p>Filtering <code>flor_all</code> to <code>aoi</code> is done with <code>filter_aoi</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="co"># Filter area of interest</span>
  <span class="va">flor_aoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_aoi.html">filter_aoi</a></span><span class="op">(</span><span class="va">flor_all</span>
                         , use_aoi <span class="op">=</span> <span class="va">aoi</span>
                         , crs_aoi <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">aoi</span><span class="op">)</span>
                         <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">flor_aoi</span>
<span class="co">#&gt; # A tibble: 1,419 x 9</span>
<span class="co">#&gt;      lat  long data_name site   date       original_name  rel_metres month  year</span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;     &lt;chr&gt;  &lt;date&gt;     &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 -34.5  140. GBIF      25739~ 2020-02-22 Eremophila gl~        500     2  2020</span>
<span class="co">#&gt;  2 -34.5  140. GBIF      39027~ 2022-08-14 Triodia scari~         NA     8  2022</span>
<span class="co">#&gt;  3 -34.5  140. GBIF      39023~ 2022-08-14 Beyeria leche~         NA     8  2022</span>
<span class="co">#&gt;  4 -34.5  140. GBIF      39020~ 2022-08-14 Walsholaria m~         NA     8  2022</span>
<span class="co">#&gt;  5 -34.5  140. GBIF      30588~ 2019-09-01 Triodia scari~        564     9  2019</span>
<span class="co">#&gt;  6 -34.5  140. GBIF      30587~ 2019-09-01 Westringia ri~        564     9  2019</span>
<span class="co">#&gt;  7 -34.5  140. GBIF      39021~ 2022-08-14 Phebalium bul~         NA     8  2022</span>
<span class="co">#&gt;  8 -34.5  140. GBIF      39026~ 2022-08-14 Acacia rigens          NA     8  2022</span>
<span class="co">#&gt;  9 -34.5  140. GBIF      39020~ 2022-08-14 Exocarpos aph~         NA     8  2022</span>
<span class="co">#&gt; 10 -34.5  140. GBIF      39233~ 2022-08-14 Maireana radi~         NA     8  2022</span>
<span class="co">#&gt; # ... with 1,409 more rows</span></code></pre></div>
<p>Check that spatial filter worked.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="co"># Create sf from flor_aoi</span>
  <span class="va">aoi_sf</span> <span class="op">&lt;-</span> <span class="va">flor_aoi</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>, <span class="st">"lat"</span><span class="op">)</span>
                 , crs <span class="op">=</span> <span class="fl">4326</span>
                 <span class="op">)</span>

  <span class="co"># Plot flor_aoi along with aoi (using the same extent/bbox as the previous plot)</span>
  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">aoi</span>
           , bbox <span class="op">=</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="va">flor_all_sf</span><span class="op">)</span>
           <span class="op">)</span> <span class="op">+</span>
    <span class="fu">tm_polygons</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">tm_shape</span><span class="op">(</span><span class="va">aoi_sf</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">tm_dots</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="020_clean_files/figure-html/flor_aoi-1.png" width="700"></p>
</div>
<div id="context" class="section level1">
<h1 class="hasAnchor">
<a href="#context" class="anchor"></a>Context: scales of interest</h1>
<p>The original location columns probably suggest metre accuracy, or even sub-metre. There may also be a field dampening expectations of such accuracy with estimates of precision for the location. In the following workflow, a precision threshold is set and then an accuracy threshold is adopted. All records with worse precision than threshold are removed, and then all records within the accuracy threshold are lumped. The lumping is done via a raster placed over the <code>aoi</code>.</p>
<p>The original time scale probably suggests accuracy to day, or perhaps even hour, or sub-hour. Choose a scale of relevance to your question. In the example below month is used. Thus all data recorded within a spatial location within a month are treated as one ‘visit’. A ‘taxa’ within a ‘visit’ is considered a ‘record’.</p>
<div id="precision" class="section level2">
<h2 class="hasAnchor">
<a href="#precision" class="anchor"></a>Precision</h2>
<p>Records with precision less than threshold are filtered using <code>filter_spat_rel</code>. This takes a dataframe (<code>df</code>) as its first argument, in this case <code>flor_aoi</code>. <code>dist_col</code> specifies the column in <code>df</code> that contains the precision estimates. <code>dist</code> provides the threshold above which to filter. If there are data sources (or any other columns in <code>df</code>) that do not include an estimate of spatial precision, but you would like to keep, this can be done with the argument <code>over_ride</code>. This takes a named list, where names need to match the columns in <code>df</code>. Any levels within the columns provided in <code>over_ride</code> will not be filtered, irrespective of the values in <code>dist_col</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">context</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"lat"</span>, <span class="st">"long"</span>, <span class="st">"cell"</span><span class="op">)</span>

  <span class="va">include_data_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALIS"</span>,<span class="st">"BCM"</span>,<span class="st">"NVB"</span>,<span class="st">"TERN"</span><span class="op">)</span>

  <span class="va">flor_rel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_spat_rel.html">filter_spat_rel</a></span><span class="op">(</span><span class="va">flor_aoi</span>
                              , dist_col <span class="op">=</span> <span class="st">"rel_metres"</span>
                              , dist <span class="op">=</span> <span class="fl">100</span>
                              , context <span class="op">=</span> <span class="va">context</span>
                              , over_ride <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>data_name <span class="op">=</span> <span class="va">include_data_name</span><span class="op">)</span>
                              <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># Have a look at results</span>
  <span class="va">flor_rel</span>
<span class="co">#&gt; # A tibble: 696 x 9</span>
<span class="co">#&gt;      lat  long data_name site   date       original_name  rel_metres month  year</span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;     &lt;chr&gt;  &lt;date&gt;     &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 -34.6  140. GBIF      10854~ 2006-10-20 Enchylaena to~         50    10  2006</span>
<span class="co">#&gt;  2 -34.6  140. GBIF      10853~ 1990-06-07 Walsholaria m~        100     6  1990</span>
<span class="co">#&gt;  3 -34.6  140. GBIF      10854~ 2006-10-20 Walsholaria m~         50    10  2006</span>
<span class="co">#&gt;  4 -34.6  140. GBIF      10853~ 1990-06-07 Roepera apicu~        100     6  1990</span>
<span class="co">#&gt;  5 -34.6  140. GBIF      10853~ 1990-06-07 Sclerolaena d~        100     6  1990</span>
<span class="co">#&gt;  6 -34.6  140. GBIF      10854~ 2006-10-20 Eucalyptus gr~         50    10  2006</span>
<span class="co">#&gt;  7 -34.6  140. GBIF      10853~ 1990-06-07 Eucalyptus gr~        100     6  1990</span>
<span class="co">#&gt;  8 -34.6  140. GBIF      10854~ 2006-10-20 Maireana erio~         50    10  2006</span>
<span class="co">#&gt;  9 -34.6  140. GBIF      10853~ 1990-06-07 Dodonaea sten~        100     6  1990</span>
<span class="co">#&gt; 10 -34.6  140. GBIF      10853~ 1990-06-07 Eucalyptus ol~        100     6  1990</span>
<span class="co">#&gt; # ... with 686 more rows</span></code></pre></div>
</div>
<div id="rasterize" class="section level2">
<h2 class="hasAnchor">
<a href="#rasterize" class="anchor"></a>Rasterize</h2>
<p>Now that records with dubious spatial precision have been removed, an accuracy threshold is adpoted by rasterizing remaining records into the cells of <code>aoi_raster</code>, created here.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">aoi_raster</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span>ext <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="va">aoi</span><span class="op">)</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span>
                      , resolution <span class="op">=</span> <span class="fl">30</span>
                      , crs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"epsg:"</span>,<span class="va">use_crs</span><span class="op">)</span>
                      <span class="op">)</span>


  <span class="va">aoi_raster</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 367, 300, 1  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 30, 30  (x, y)</span>
<span class="co">#&gt; extent      : 723000, 732000, -3800000, -3788990  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : GDA94 / Australian Albers (EPSG:3577)</span></code></pre></div>
<p>Rasterizing the current data is then done via <code>add_raster_cell</code>. This function has the argument <code>add_xy</code> which will add the centroid of the cell back to the data frame using the same names as the original <code>x</code> and <code>y</code> columns. Alternatively, the <code>x</code> and <code>y</code> columns will be lost from the returned data frame, replaced with <code>cell</code>, the raster cell id.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">flor_cell</span> <span class="op">&lt;-</span> <span class="fu">envRaster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/envRaster/man/add_raster_cell.html">add_raster_cell</a></span><span class="op">(</span><span class="va">aoi_raster</span>
                               , <span class="va">flor_rel</span>
                               , add_xy <span class="op">=</span> <span class="cn">TRUE</span>
                               , crs_df <span class="op">=</span> <span class="fl">4283</span>
                               <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">flor_cell</span>
<span class="co">#&gt; # A tibble: 696 x 10</span>
<span class="co">#&gt;     cell  long   lat data_name site   date       original_name  rel_metres month</span>
<span class="co">#&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;     &lt;chr&gt;  &lt;date&gt;     &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1  7340  140. -34.5 GBIF      10854~ 2006-10-18 Maireana radi~         50    10</span>
<span class="co">#&gt;  2  7340  140. -34.5 GBIF      10854~ 2006-10-18 Roepera glauca         50    10</span>
<span class="co">#&gt;  3  7340  140. -34.5 GBIF      10854~ 2006-10-18 Beyeria leche~         50    10</span>
<span class="co">#&gt;  4  7340  140. -34.5 GBIF      10854~ 2006-10-18 Melaleuca lan~         50    10</span>
<span class="co">#&gt;  5  7340  140. -34.5 GBIF      10854~ 2006-10-18 Sclerolaena p~         50    10</span>
<span class="co">#&gt;  6  7340  140. -34.5 GBIF      10854~ 2006-10-18 Maireana erio~         50    10</span>
<span class="co">#&gt;  7  7340  140. -34.5 GBIF      10854~ 2006-10-18 Eucalyptus ol~         50    10</span>
<span class="co">#&gt;  8  7340  140. -34.5 GBIF      10854~ 2006-10-18 Westringia ri~         50    10</span>
<span class="co">#&gt;  9  7340  140. -34.5 GBIF      10854~ 2006-10-18 Maireana pent~         50    10</span>
<span class="co">#&gt; 10  7340  140. -34.5 GBIF      10854~ 2006-10-18 Walsholaria m~         50    10</span>
<span class="co">#&gt; # ... with 686 more rows, and 1 more variable: year &lt;dbl&gt;</span></code></pre></div>
</div>
</div>
<div id="taxonomy" class="section level1">
<h1 class="hasAnchor">
<a href="#taxonomy" class="anchor"></a>Taxonomy</h1>
<div id="make-taxonomy" class="section level2">
<h2 class="hasAnchor">
<a href="#make-taxonomy" class="anchor"></a>Make taxonomy</h2>
<p>Historically, reconciling taxonomy has been by far the most time-consuming, and necessarily expert-driven part of cleaning biological data from any unstructured data set(s). In the past it was often necessary to get an expert botanist to generate an analysis specific taxonomy, taking into account such things as the area of interest, timing (e.g. decade (was it a wet decade), season (was the timing right for orchids or not?)) of the of the main previous surveys, and even possibly the expertise-at-survey-time of the observers. Nothing will replace the quality of the results from such a process. Using online taxonomic tools such as the <a href="https://www.gbif.org/dataset/d7dddbf4-2cf0-4f39-9b2a-bb099caae36c">GBIF taxonomy backbone</a> provides an automated alternative that comes with an unquantified (but unlikely to be negligible) penalty in quality. However, the enormous benefit in flexibility and time provided by automated tools makes them essential in practice.</p>
<p>Reconciling taxonomy can be done with the <code>make_taxa_taxonomy</code> function. This returns a list with two objects:</p>
<ul>
<li>
<code>lutaxa.</code> This is a simple lookup from the original name provided to the taxa to use in place of that name. Thus, <code>taxa</code> is likely to be duplicated</li>
<li>
<code>taxa_taxonomy</code> provides the full taxonomic hierarchy for each <code>taxa</code> in the <code>lutaxa</code> object. The column <code>taxa</code> should not have any duplicates. The output can also include lifespan and indigenous status columns, if they are available from any of the original data sources and they are provided to <code>make_taxa_taxonomy</code>.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">taxa</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/make_taxa_taxonomy.html">make_taxa_taxonomy</a></span><span class="op">(</span><span class="va">flor_cell</span>
                              , out_file <span class="op">=</span> <span class="st">"inst/luGBIF.rds"</span>
                              <span class="op">)</span></code></pre></div>
<p>A look at <code>lutaxa</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">taxa</span><span class="op">$</span><span class="va">lutaxa</span>
<span class="co">#&gt; # A tibble: 579 x 4</span>
<span class="co">#&gt;    taxa                   searched_name          original_name          rank   </span>
<span class="co">#&gt;    &lt;chr&gt;                  &lt;chr&gt;                  &lt;chr&gt;                  &lt;ord&gt;  </span>
<span class="co">#&gt;  1 Plantae                Zosterops lateralis    Zosterops lateralis    kingdom</span>
<span class="co">#&gt;  2 Walsholaria muelleri   Walsholaria muelleri   Walsholaria muelleri   species</span>
<span class="co">#&gt;  3 Walsholaria magniflora Walsholaria magniflora Walsholaria magniflora species</span>
<span class="co">#&gt;  4 Vittadinia dissecta    Vittadinia dissecta    Vittadinia dissecta    species</span>
<span class="co">#&gt;  5 Vittadinia cuneata     Vittadinia cuneata     Vittadinia cuneata     species</span>
<span class="co">#&gt;  6 Plantae                Varanus gouldii        Varanus gouldii        kingdom</span>
<span class="co">#&gt;  7 Plantae                Tyto javanica          Tyto javanica          kingdom</span>
<span class="co">#&gt;  8 Plantae                Todiramphus sanctus    Todiramphus sanctus    kingdom</span>
<span class="co">#&gt;  9 Plantae                Tiliqua rugosa         Tiliqua rugosa         kingdom</span>
<span class="co">#&gt; 10 Plantae                Tachyglossus aculeatus Tachyglossus aculeatus kingdom</span>
<span class="co">#&gt; # ... with 569 more rows</span></code></pre></div>
<p>and <code>taxa_taxonomy</code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">taxa</span><span class="op">$</span><span class="va">taxa_taxonomy</span>
<span class="co">#&gt; # A tibble: 197 x 8</span>
<span class="co">#&gt;    taxa                     kingdom phylum  order  family  genus  species  class</span>
<span class="co">#&gt;    &lt;chr&gt;                    &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt;  1 Plantae                  Plantae &lt;NA&gt;    &lt;NA&gt;   &lt;NA&gt;    &lt;NA&gt;   &lt;NA&gt;     &lt;NA&gt; </span>
<span class="co">#&gt;  2 Walsholaria muelleri     Plantae Trache~ Aster~ Astera~ Walsh~ Walshol~ Magn~</span>
<span class="co">#&gt;  3 Walsholaria magniflora   Plantae Trache~ Aster~ Astera~ Walsh~ Walshol~ Magn~</span>
<span class="co">#&gt;  4 Vittadinia dissecta      Plantae Trache~ Aster~ Astera~ Vitta~ Vittadi~ Magn~</span>
<span class="co">#&gt;  5 Vittadinia cuneata       Plantae Trache~ Aster~ Astera~ Vitta~ Vittadi~ Magn~</span>
<span class="co">#&gt;  6 Senna artemisioides      Plantae Trache~ Fabal~ Fabace~ Senna  Senna a~ Magn~</span>
<span class="co">#&gt;  7 Senecio pinnatifolius    Plantae Trache~ Aster~ Astera~ Senec~ Senecio~ Magn~</span>
<span class="co">#&gt;  8 Sabulina mediterranea    Plantae Trache~ Caryo~ Caryop~ Sabul~ Sabulin~ Magn~</span>
<span class="co">#&gt;  9 Rytidosperma caespitosum Plantae Trache~ Poales Poaceae Rytid~ Rytidos~ Lili~</span>
<span class="co">#&gt; 10 Rumicastrum eremaeum     Plantae Trache~ Caryo~ Montia~ Rumic~ Rumicas~ Magn~</span>
<span class="co">#&gt; # ... with 187 more rows</span></code></pre></div>
</div>
<div id="filter-taxonomy" class="section level2">
<h2 class="hasAnchor">
<a href="#filter-taxonomy" class="anchor"></a>Filter taxonomy</h2>
<p>Cleaning to a single taxonomy is now possible sing <code>lutaxa</code> and <code>taxa_taxonomy</code>.</p>
<p>At this point, the <a href="#context">context</a> is also <em>exclusively</em> applied.</p>
<p>Thus the output of applying <code>filter_taxa</code> is to generate a single record for each taxa within each context. An attempt will also be made to provide a single value for any <code>extra_cols</code> but this will fail to provide a unique result if there are values within any of <code>extra_cols</code> that are not equivalent within a taxa and context.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">flor_taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_taxa.html">filter_taxa</a></span><span class="op">(</span><span class="va">flor_cell</span>
                          , taxa_col <span class="op">=</span> <span class="st">"original_name"</span>
                          , context <span class="op">=</span> <span class="va">context</span>
                          , taxonomy <span class="op">=</span> <span class="va">taxa</span>
                          <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">flor_taxa</span>
<span class="co">#&gt; # A tibble: 694 x 6</span>
<span class="co">#&gt;     year month   lat  long  cell taxa                </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;               </span>
<span class="co">#&gt;  1  2006    10 -34.5  140.  7340 Maireana radiata    </span>
<span class="co">#&gt;  2  2006    10 -34.6  140. 95018 Maireana radiata    </span>
<span class="co">#&gt;  3  2006    10 -34.5  140.  7340 Roepera glauca      </span>
<span class="co">#&gt;  4  1990     5 -34.5  140. 18098 Roepera glauca      </span>
<span class="co">#&gt;  5  1990     6 -34.6  140. 80157 Roepera glauca      </span>
<span class="co">#&gt;  6  2006    10 -34.6  140. 83038 Roepera glauca      </span>
<span class="co">#&gt;  7  2006    10 -34.6  140. 84812 Roepera glauca      </span>
<span class="co">#&gt;  8  2006    10 -34.5  140.  7340 Beyeria lechenaultii</span>
<span class="co">#&gt;  9  2006    10 -34.5  140. 14814 Beyeria lechenaultii</span>
<span class="co">#&gt; 10  1990     5 -34.5  140. 18417 Beyeria lechenaultii</span>
<span class="co">#&gt; # ... with 684 more rows</span></code></pre></div>
</div>
</div>
<div id="singletons" class="section level1">
<h1 class="hasAnchor">
<a href="#singletons" class="anchor"></a>Singletons</h1>
<p>An implicit assumption in collation of data sources is usually that records were a list of taxa collected at a specific spatial location (and date). In many cases this assumption proves incorrect. For example, records may be related to, say, tree health monitoring where no other taxa were concurrently recorded.</p>
<p>Thus, filtering ‘singleton’ sites (a site with only a single taxa was recorded) is often prudent.</p>
<p>This will also inadvertently filter legitimate single taxa lists. For example, some areas of samphire or mangroves may have only a single taxa recorded within a survey site. As always, it depends on the goal of any particular analysis whether this trade-off will be worthwhile.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">  
  <span class="co"># Filter singletons</span>
  <span class="va">flor_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_counts.html">filter_counts</a></span><span class="op">(</span><span class="va">flor_taxa</span>
                              , context <span class="op">=</span> <span class="va">context</span>
                              , thresh <span class="op">=</span> <span class="fl">1</span>
                              <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">flor_single</span>
<span class="co">#&gt; # A tibble: 692 x 6</span>
<span class="co">#&gt;     year month   lat  long  cell taxa                </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;               </span>
<span class="co">#&gt;  1  2006    10 -34.5  140.  7340 Maireana radiata    </span>
<span class="co">#&gt;  2  2006    10 -34.6  140. 95018 Maireana radiata    </span>
<span class="co">#&gt;  3  2006    10 -34.5  140.  7340 Roepera glauca      </span>
<span class="co">#&gt;  4  1990     5 -34.5  140. 18098 Roepera glauca      </span>
<span class="co">#&gt;  5  1990     6 -34.6  140. 80157 Roepera glauca      </span>
<span class="co">#&gt;  6  2006    10 -34.6  140. 83038 Roepera glauca      </span>
<span class="co">#&gt;  7  2006    10 -34.6  140. 84812 Roepera glauca      </span>
<span class="co">#&gt;  8  2006    10 -34.5  140.  7340 Beyeria lechenaultii</span>
<span class="co">#&gt;  9  2006    10 -34.5  140. 14814 Beyeria lechenaultii</span>
<span class="co">#&gt; 10  1990     5 -34.5  140. 18417 Beyeria lechenaultii</span>
<span class="co">#&gt; # ... with 682 more rows</span></code></pre></div>
</div>
<div id="effort" class="section level1">
<h1 class="hasAnchor">
<a href="#effort" class="anchor"></a>Effort</h1>
<p>Aggregated data sets are likely to contain records of taxa at spatial locations collected by almost any method imaginable. The effort any observer(s) put into time and taxonomy at each spatial location is usually unknown.</p>
<p>Given that effort matters when documenting ecology <span class="citation">(e.g. Wiens 1989)</span>, filtering ‘effort’ is an attempt to remove the most seriously under- and over-sampled contexts.</p>
<p>Examples of low taxa richness contexts that may occur in large, unstructured data sets:</p>
<ul>
<li>brief, opportune records</li>
<li>tree-health monitoring data</li>
</ul>
<p>Examples of high taxa richness contexts that may occur in large, unstructured data sets:</p>
<ul>
<li>an observer wandering widely from the location they recorded, particularly if crossing an ecotone</li>
<li>several observers working together</li>
<li>an observer with well above average botanical knowledge</li>
<li>observations taken over a long time-frame but recorded on a single day</li>
</ul>
<p>These examples just scratch the surface of the ways in which taxa richness can deviate from that expected from an average effort by an average observer.</p>
<p>Taxa richness can be modelled as a function of any variables of interest, for example:</p>
<ul>
<li>nothing. This option might be useful in relatively small areas where the non-biological drivers of biological change are relatively stable</li>
<li>a continuous variable of interest. Say, annual mean temperature, or, soil ph</li>
<li>principal components. This option is best suited to analyses accompanied by many variables all of which are drivers, or closely correlated with, biological change</li>
<li>a categorical variable of interest. Say, <a href="https://www.awe.gov.au/agriculture-land/land/nrs/science/ibra">IBRA</a> Subregions</li>
</ul>
<p>Taxa richness can be modelled using a Bayesian generalised linear model using the <code>make_effort_mod</code> function. This implements the <code>rstan_glm</code> function in the <code>rstanarm</code> package <span class="citation">(Gabry and Goodrich 2020; Brilleman et al. 2018)</span>. The resulting model is used to predict upper and lower bounds for acceptable taxa richness, by choosing acceptable lower and upper percentiles or richness.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="co"># run model</span>
  <span class="va">effort_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_effort_mod.html">make_effort_mod</a></span><span class="op">(</span><span class="va">flor_single</span>
                                , context <span class="op">=</span> <span class="va">context</span>
                                <span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'count' NOW (CHAIN 1).</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Gradient evaluation took 0 seconds</span>
<span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.</span>
<span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1:  Elapsed Time: 0.229 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 1:                0.236 seconds (Sampling)</span>
<span class="co">#&gt; Chain 1:                0.465 seconds (Total)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'count' NOW (CHAIN 2).</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Gradient evaluation took 0 seconds</span>
<span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.</span>
<span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2:  Elapsed Time: 0.239 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 2:                0.216 seconds (Sampling)</span>
<span class="co">#&gt; Chain 2:                0.455 seconds (Total)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'count' NOW (CHAIN 3).</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Gradient evaluation took 0 seconds</span>
<span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.</span>
<span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3:  Elapsed Time: 0.242 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 3:                0.252 seconds (Sampling)</span>
<span class="co">#&gt; Chain 3:                0.494 seconds (Total)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL 'count' NOW (CHAIN 4).</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Gradient evaluation took 0 seconds</span>
<span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.</span>
<span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4:  Elapsed Time: 0.246 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 4:                0.251 seconds (Sampling)</span>
<span class="co">#&gt; Chain 4:                0.497 seconds (Total)</span>
<span class="co">#&gt; Chain 4:</span>

  <span class="co"># filter using model results</span>
  <span class="va">flor_effort</span> <span class="op">&lt;-</span> <span class="va">flor_single</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">effort_mod</span><span class="op">$</span><span class="va">mod_cell_result</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
                        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">keep</span><span class="op">)</span>
                      <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flor_single</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">flor_effort</span>
<span class="co">#&gt; # A tibble: 692 x 6</span>
<span class="co">#&gt;     year month   lat  long  cell taxa                </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;               </span>
<span class="co">#&gt;  1  2006    10 -34.5  140.  7340 Maireana radiata    </span>
<span class="co">#&gt;  2  2006    10 -34.6  140. 95018 Maireana radiata    </span>
<span class="co">#&gt;  3  2006    10 -34.5  140.  7340 Roepera glauca      </span>
<span class="co">#&gt;  4  1990     5 -34.5  140. 18098 Roepera glauca      </span>
<span class="co">#&gt;  5  1990     6 -34.6  140. 80157 Roepera glauca      </span>
<span class="co">#&gt;  6  2006    10 -34.6  140. 83038 Roepera glauca      </span>
<span class="co">#&gt;  7  2006    10 -34.6  140. 84812 Roepera glauca      </span>
<span class="co">#&gt;  8  2006    10 -34.5  140.  7340 Beyeria lechenaultii</span>
<span class="co">#&gt;  9  2006    10 -34.5  140. 14814 Beyeria lechenaultii</span>
<span class="co">#&gt; 10  1990     5 -34.5  140. 18417 Beyeria lechenaultii</span>
<span class="co">#&gt; # ... with 682 more rows</span></code></pre></div>
</div>
<div id="proportion-of-sites-at-which-a-taxa-occurs" class="section level1">
<h1 class="hasAnchor">
<a href="#proportion-of-sites-at-which-a-taxa-occurs" class="anchor"></a>Proportion of sites at which a taxa occurs</h1>
<p>When clustering biological data, it is often useful to exclude rare taxa from the data set. <code>filter_prop</code> allows filtering such taxa.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R">  
  <span class="co"># Filter taxa recorded at less than 5% of contexts</span>
  <span class="va">flor_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_prop.html">filter_prop</a></span><span class="op">(</span><span class="va">flor_effort</span>
                           , context <span class="op">=</span> <span class="va">context</span>
                           , default_per <span class="op">=</span> <span class="fl">5</span>
                           <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># Have a look at results</span>
  <span class="va">flor_prop</span>
<span class="co">#&gt; # A tibble: 612 x 6</span>
<span class="co">#&gt;     year month   lat  long  cell taxa                </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;               </span>
<span class="co">#&gt;  1  2006    10 -34.5  140.  7340 Roepera glauca      </span>
<span class="co">#&gt;  2  1990     5 -34.5  140. 18098 Roepera glauca      </span>
<span class="co">#&gt;  3  1990     6 -34.6  140. 80157 Roepera glauca      </span>
<span class="co">#&gt;  4  2006    10 -34.6  140. 83038 Roepera glauca      </span>
<span class="co">#&gt;  5  2006    10 -34.6  140. 84812 Roepera glauca      </span>
<span class="co">#&gt;  6  2006    10 -34.5  140.  7340 Beyeria lechenaultii</span>
<span class="co">#&gt;  7  2006    10 -34.5  140. 14814 Beyeria lechenaultii</span>
<span class="co">#&gt;  8  1990     5 -34.5  140. 18417 Beyeria lechenaultii</span>
<span class="co">#&gt;  9  2006    10 -34.5  140. 19607 Beyeria lechenaultii</span>
<span class="co">#&gt; 10  2006    10 -34.5  140. 22287 Beyeria lechenaultii</span>
<span class="co">#&gt; # ... with 602 more rows</span></code></pre></div>
</div>
<div id="time" class="section level1">
<h1 class="hasAnchor">
<a href="#time" class="anchor"></a>Time</h1>
<p>So far, all contexts year, month, lat, long or cell have been kept. It may be desirable to keep only the most recent contexts. Just use <code>dplyr</code>…</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">flor_recent</span> <span class="op">&lt;-</span> <span class="va">flor_prop</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">any_of</span><span class="op">(</span><span class="va">context</span><span class="op">[</span><span class="op">!</span><span class="va">context</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"month"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>
                  , <span class="va">month</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>
                  <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">add_time_stamp</span><span class="op">(</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">flor_recent</span>
<span class="co">#&gt; # A tibble: 541 x 6</span>
<span class="co">#&gt;     year month   lat  long  cell taxa                </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;               </span>
<span class="co">#&gt;  1  2006    10 -34.5  140.  7340 Roepera glauca      </span>
<span class="co">#&gt;  2  1990     5 -34.5  140. 18098 Roepera glauca      </span>
<span class="co">#&gt;  3  2006    10 -34.6  140. 83038 Roepera glauca      </span>
<span class="co">#&gt;  4  2006    10 -34.6  140. 84812 Roepera glauca      </span>
<span class="co">#&gt;  5  2006    10 -34.5  140.  7340 Beyeria lechenaultii</span>
<span class="co">#&gt;  6  2006    10 -34.5  140. 14814 Beyeria lechenaultii</span>
<span class="co">#&gt;  7  1990     5 -34.5  140. 18417 Beyeria lechenaultii</span>
<span class="co">#&gt;  8  2006    10 -34.5  140. 19607 Beyeria lechenaultii</span>
<span class="co">#&gt;  9  2006    10 -34.5  140. 22287 Beyeria lechenaultii</span>
<span class="co">#&gt; 10  2006    10 -34.5  140. 37727 Beyeria lechenaultii</span>
<span class="co">#&gt; # ... with 531 more rows</span></code></pre></div>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Filtering summary</h1>
<p>A little care naming objects enables easily capturing the results of the cleaning process. The function <code>rec_vis_sit_tax</code> summarises the taxa, records, visits and sites in each <code>flor_</code> data frame.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R">  
  <span class="va">filt_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"flor_"</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>, value <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>obj <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">name</span>,<span class="va">get</span><span class="op">)</span>
                  , has_stamp <span class="op">=</span> <span class="fu">map_lgl</span><span class="op">(</span><span class="va">obj</span>,<span class="op">~</span><span class="st">"ctime"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                  <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">has_stamp</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">obj</span>, <span class="va">nrow</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ctime <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">obj</span>,<span class="va">attr</span>,<span class="st">"ctime"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ctime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">nrow</span><span class="op">)</span>,<span class="va">ctime</span><span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>summary <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">obj</span>
                                , <span class="va">rec_vis_sit_tax</span>
                                , site_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cell"</span>, <span class="st">"lat"</span>, <span class="st">"long"</span><span class="op">)</span>
                                , visit_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"month"</span>, <span class="st">"year"</span><span class="op">)</span>
                                , taxa_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"taxa"</span>, <span class="st">"original_name"</span><span class="op">)</span>
                                <span class="op">)</span>
                  <span class="op">)</span> <span class="op"><a href="../reference/%&gt;%.html">%&gt;%</a></span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">summary</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># Have a look at results</span>
  <span class="va">filt_summary</span>
<span class="co">#&gt; # A tibble: 8 x 9</span>
<span class="co">#&gt;   name    obj     has_stamp  nrow ctime                taxa records visits sites</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;list&gt;  &lt;lgl&gt;     &lt;dbl&gt; &lt;dttm&gt;              &lt;int&gt;   &lt;int&gt;  &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 flor_a~ &lt;tibbl~ TRUE       1419 2023-02-23 23:10:57   213    1419     24   141</span>
<span class="co">#&gt; 2 flor_r~ &lt;tibbl~ TRUE        696 2023-02-23 23:10:58   130     696      8    40</span>
<span class="co">#&gt; 3 flor_c~ &lt;tibbl~ TRUE        696 2023-02-23 23:11:02   130     696      8    38</span>
<span class="co">#&gt; 4 flor_t~ &lt;tibbl~ TRUE        694 2023-02-23 23:11:02   129     694      8    38</span>
<span class="co">#&gt; 5 flor_s~ &lt;tibbl~ TRUE        692 2023-02-23 23:11:03   128     692      7    36</span>
<span class="co">#&gt; 6 flor_e~ &lt;tibbl~ TRUE        692 2023-02-23 23:11:06   128     692      7    36</span>
<span class="co">#&gt; 7 flor_p~ &lt;tibbl~ TRUE        612 2023-02-23 23:11:06    71     612      7    36</span>
<span class="co">#&gt; 8 flor_r~ &lt;tibbl~ TRUE        541 2023-02-23 23:11:06    71     541      7    36</span></code></pre></div>
</div>
<div id="what-happened-to-x" class="section level1">
<h1 class="hasAnchor">
<a href="#what-happened-to-x" class="anchor"></a>What happened to x?</h1>
<p>It can often be useful to trace the results for a single taxa through the filtering process. How did, say, <em>Eucalyptus incrassata</em> fare through the process?</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="fu"><a href="../reference/find_taxa.html">find_taxa</a></span><span class="op">(</span>taxa <span class="op">=</span> <span class="st">"Eucalyptus incrassata"</span>
            , lookup_taxa <span class="op">=</span> <span class="va">taxa</span><span class="op">$</span><span class="va">lutaxa</span>
            <span class="op">)</span>
<span class="co">#&gt; # A tibble: 8 x 6</span>
<span class="co">#&gt;   name        obj              has_stamp  nrow ctime               summary      </span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;list&gt;           &lt;lgl&gt;     &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;        </span>
<span class="co">#&gt; 1 flor_aoi    &lt;tibble [1 x 2]&gt; TRUE       1419 2023-02-23 23:10:57 Eucalyptus i~</span>
<span class="co">#&gt; 2 flor_rel    &lt;tibble [1 x 2]&gt; TRUE        696 2023-02-23 23:10:58 Eucalyptus i~</span>
<span class="co">#&gt; 3 flor_cell   &lt;tibble [1 x 2]&gt; TRUE        696 2023-02-23 23:11:02 Eucalyptus i~</span>
<span class="co">#&gt; 4 flor_taxa   &lt;tibble [1 x 2]&gt; TRUE        694 2023-02-23 23:11:02 Eucalyptus i~</span>
<span class="co">#&gt; 5 flor_single &lt;tibble [1 x 2]&gt; TRUE        692 2023-02-23 23:11:03 Eucalyptus i~</span>
<span class="co">#&gt; 6 flor_effort &lt;tibble [1 x 2]&gt; TRUE        692 2023-02-23 23:11:06 Eucalyptus i~</span>
<span class="co">#&gt; 7 flor_prop   &lt;tibble [1 x 2]&gt; TRUE        612 2023-02-23 23:11:06 Eucalyptus i~</span>
<span class="co">#&gt; 8 flor_recent &lt;tibble [1 x 2]&gt; TRUE        541 2023-02-23 23:11:06 Eucalyptus i~</span></code></pre></div>
</div>
<div id="summary-1" class="section level1">
<h1 class="hasAnchor">
<a href="#summary-1" class="anchor"></a>Summary</h1>
<p>After ingesting data from a range of sources (GBIF) the <code>envClean</code> functions helped clean the data ready for further analysis. The original 1419 records were cleaned, tidied and filtered to 541 records.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-rstanarm2018">
<p>Brilleman, SL, MJ Crowther, M Moreno-Betancur, J Buros Novik, and R Wolfe. 2018. “Joint Longitudinal and Time-to-Event Models via Stan.” <a href="https://github.com/stan-dev/stancon_talks/">https://github.com/stan-dev/stancon_talks/</a>.</p>
</div>
<div id="ref-R-rstanarm">
<p>Gabry, Jonah, and Ben Goodrich. 2020. <em>Rstanarm: Bayesian Applied Regression Modeling via Stan</em>. <a href="https://CRAN.R-project.org/package=rstanarm">https://CRAN.R-project.org/package=rstanarm</a>.</p>
</div>
<div id="ref-GBIFRef_6">
<p>GBIF.Org. 2022. “GBIF Occurrence Download.” The Global Biodiversity Information Facility. <a href="https://doi.org/10.15468/DL.ZK34YK">https://doi.org/10.15468/DL.ZK34YK</a>.</p>
</div>
<div id="ref-RN2377">
<p>Wiens, J A. 1989. “Spatial scaling in ecology.” Journal Article. <em>Functional Ecology</em> 3 (4): 385–97.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nigel Willoughby.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
